---
- name: Lab 9 - Configuration Backup and Restore
  hosts: csr
  connection: network_cli
  gather_facts: no
  
  vars:
    ansible_network_os: ios
    backup_dir: \"./backups\"\n    timestamp: \"{{ ansible_date_time.year }}{{ ansible_date_time.month }}{{ ansible_date_time.day }}-{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}{{ ansible_date_time.second }}\"\n    \n  tasks:\n    - name: Gather timestamp facts\n      setup:\n        filter: ansible_date_time\n      delegate_to: localhost\n      \n    - name: Create backup directory\n      file:\n        path: \"{{ backup_dir }}\"\n        state: directory\n      delegate_to: localhost\n      \n    - name: Backup current running configuration\n      cisco.ios.ios_command:\n        commands:\n          - show running-config\n      register: running_config\n      \n    - name: Save running config to backup file\n      copy:\n        content: \"{{ running_config.stdout[0] }}\"\n        dest: \"{{ backup_dir }}/{{ inventory_hostname }}-running-{{ timestamp }}.cfg\"\n      delegate_to: localhost\n      \n    - name: Backup startup configuration\n      cisco.ios.ios_command:\n        commands:\n          - show startup-config\n      register: startup_config\n      \n    - name: Save startup config to backup file\n      copy:\n        content: \"{{ startup_config.stdout[0] }}\"\n        dest: \"{{ backup_dir }}/{{ inventory_hostname }}-startup-{{ timestamp }}.cfg\"\n      delegate_to: localhost\n      \n    - name: Get device facts for backup metadata\n      cisco.ios.ios_facts:\n        gather_subset: default\n      register: device_info\n      \n    - name: Create backup metadata file\n      copy:\n        content: |\n          Backup Information:\n          Device: {{ inventory_hostname }}\n          Hostname: {{ ansible_net_hostname }}\n          IOS Version: {{ ansible_net_version }}\n          Model: {{ ansible_net_model }}\n          Serial: {{ ansible_net_serialnum }}\n          Backup Date: {{ ansible_date_time.iso8601 }}\n          Running Config Size: {{ running_config.stdout[0] | length }} characters\n          Startup Config Size: {{ startup_config.stdout[0] | length }} characters\n        dest: \"{{ backup_dir }}/{{ inventory_hostname }}-metadata-{{ timestamp }}.txt\"\n      delegate_to: localhost\n      \n    - name: Configure archive settings on device\n      cisco.ios.ios_config:\n        lines:\n          - archive\n          - path flash:archive-config\n          - maximum 10\n          - time-period 1440\n      register: archive_config\n      \n    - name: Save running config to startup\n      cisco.ios.ios_command:\n        commands:\n          - copy running-config startup-config\n      register: save_config\n      \n    - name: Display backup file creation\n      debug:\n        msg: \"Backup files created: {{ backup_dir }}/{{ inventory_hostname }}-*-{{ timestamp }}.cfg\"\n        \n    - name: Display archive configuration\n      debug:\n        msg: \"Archive configuration: {{ archive_config.commands | default('No changes') }}\"\n        \n    - name: Create a test configuration change\n      cisco.ios.ios_config:\n        lines:\n          - description \"Backup test - {{ timestamp }}\"\n        parents: interface Loopback99\n      register: test_change\n      \n    - name: Backup configuration after test change\n      cisco.ios.ios_command:\n        commands:\n          - show running-config\n      register: modified_config\n      \n    - name: Save modified config to backup file\n      copy:\n        content: \"{{ modified_config.stdout[0] }}\"\n        dest: \"{{ backup_dir }}/{{ inventory_hostname }}-modified-{{ timestamp }}.cfg\"\n      delegate_to: localhost\n      \n    - name: Compare configurations (show differences)\n      debug:\n        msg: \"Configuration modified - new backup created with test interface Loopback99\"\n        \n    - name: Remove test configuration\n      cisco.ios.ios_config:\n        lines:\n          - no interface Loopback99\n      register: cleanup_change\n      \n    - name: Demonstrate configuration restore capability\n      debug:\n        msg: \"To restore configuration, use: configure replace {{ backup_dir }}/{{ inventory_hostname }}-running-{{ timestamp }}.cfg\"\n        \n    - name: Verify backup files exist\n      stat:\n        path: \"{{ backup_dir }}/{{ inventory_hostname }}-running-{{ timestamp }}.cfg\"\n      register: backup_file_check\n      delegate_to: localhost\n      \n    - name: Display backup verification\n      debug:\n        msg: \"Backup file verified: {{ 'EXISTS' if backup_file_check.stat.exists else 'MISSING' }}\"\n        \n    - name: List all backup files for this device\n      find:\n        paths: \"{{ backup_dir }}\"\n        patterns: \"{{ inventory_hostname }}-*.cfg\"\n      register: backup_files\n      delegate_to: localhost\n      \n    - name: Display available backup files\n      debug:\n        msg: \"Available backups: {{ backup_files.files | map(attribute='path') | list }}\"\n        \n    - name: Create backup summary report\n      copy:\n        content: |\n          Configuration Backup Summary Report\n          Generated: {{ ansible_date_time.iso8601 }}\n          \n          Device: {{ inventory_hostname }}\n          Backup Files Created:\n          {% for file in backup_files.files %}\n          - {{ file.path | basename }} ({{ file.size }} bytes, {{ file.mtime | strftime('%Y-%m-%d %H:%M:%S') }})\n          {% endfor %}\n          \n          Archive Settings: {{ archive_config.commands | join(', ') if archive_config.commands else 'No changes' }}\n          \n          Notes:\n          - Regular backups should be scheduled via cron/scheduler\n          - Store backups in version control system for change tracking\n          - Test restore procedures regularly\n        dest: \"{{ backup_dir }}/backup-report-{{ timestamp }}.txt\"\n      delegate_to: localhost"